# AIOps-Intelligent-RCA: 核心概念与架构设计

> **Author:** qingshanyuluo **Status:** Production-Ready **Core Philosophy:** "Heavy Collection, Smart Reasoning"

## 1. 序言：工程化的胜利

本项目不迷信 LLM 的黑盒能力。在真实的生产环境中，Agent 的智商上限取决于 **上下文（Context）** 的质量。
我们的核心设计理念是：**在 Agent 介入之前，通过确定性算法完成“战场清洗”和“全量取证”。**

## 2. 诊断流水线 (The Pipeline)

我们将 RCA 过程重构为三个严格的阶段：**拦截 -> 采集 -> 分析**。

### Stage 1: 全局共模拦截 (The Shield)
**解决痛点：** 基础设施故障导致的“告警风暴”与“AI 幻觉”。

在启动任何单应用分析之前，系统首先运行 **归一化与时空相关性检测算法 (Phase 6)**：
*   **逻辑：** 实时计算 Top N 报错应用的错误率曲线。
*   **判定：** 如果应用间错误曲线的 **Pearson 相关系数 $R > 0.85$** 且拓扑上互不相关（离散）。
*   **动作：** **直接熔断**。判定为网络专线抖动或基础设施故障，终止后续所有 Agent 任务，输出全局告警。

### Stage 2: 智能数据采集与补全 (The Dragnet)
**解决痛点：** Trace 断裂、下游隐性劣化（不报错但变慢）、数据不完整。

这是本架构最关键的**“补全”**步骤。系统不仅仅拉取报错应用的 Trace，而是启动 **Z-Score 自适应异常检测算法**，对全局服务进行“拉网式排查”。

#### 核心算法：基于 Z-Score 的自适应检测
系统扫描全局应用，寻找所有满足以下条件的服务，将其指标和日志一并打包进 Context：

1.  **自适应基线：** 基于过去 1 小时数据的均值 ($\mu$) 和标准差 ($\sigma$) 建立模型。
2.  **异常判定：**
    $$Z = \frac{\text{CurrentMax} - \mu}{\sigma + \text{NoiseFloor}}$$
    *   **Noise Floor (噪音保护):** 防止低波动服务的数学误报。
    *   **QPS 门槛:** 过滤小流量服务的统计噪声。
3.  **价值：**
    *   **解决断链：** 即使 Trace 在 A 处断裂，下游 C 因为变慢被 Z-Score 算法捕获。A 和 C 同时出现在 Context 中，Agent 即可通过拓扑知识将其关联。
    *   **发现隐患：** 捕捉到那些“沉默”但耗时突增的罪魁祸首。

### Stage 3: 内存图构建与入口决策 (The Anchor)
**解决痛点：** 选错分析入口（受害者 vs 始作俑者）。

基于 Stage 2 采集到的全量数据（Trace + Z-Score 异常列表），在内存中构建 **加权拓扑图 (Phase 7)**：
*   **权重计算：** $$W = (交互耗时 \times N+1) + (传输损耗) + (错误惩罚)$$
*   **决策：** 综合 Trace 中的显性错误和 Z-Score 发现的隐性高耗时节点，计算出破坏力最大的节点作为 **Agent 的唯一分析入口**。

### Stage 4: Agent 深度分析 (The Surgeon)
**解决痛点：** 最终定性与报告生成。

此时，Agent 进场。它面对的不再是破碎的片段，而是一个**经过清洗、补全、数学验证过的完整案发现场**。
*   **RaaT (Retrieval-as-a-Tool):** Agent 通过 `analyze_metrics_report` 等高阶工具读取已缓存的指标快照。
*   **反事实验证:** 进行最终的逻辑闭环（例如：“确认下游 C 的 Z-Score 飙升是导致 A 线程池满的唯一原因”）。
*   **语义纠偏:** 遵循“拓扑真理”原则，无视服务命名误导，输出最终根因报告。

---

## 3. 核心算法详解 (Key Algorithms)

### 3.1 工业级微服务耗时异常检测 (At Collection Layer)
为了在数据采集阶段解决“断链”和“漏判”，我们引入了非对称采样的 Z-Score 算法：
*   **Target (当前):** 取过去 5 分钟内，每分钟平均耗时的**最大值**（捕捉瞬间尖刺）。
*   **Baseline (历史):** 取过去 1 小时的均值与标准差。
*   **优势:**
    *   **对稳定服务敏感:** 标准差小，微小劣化立刻被捕获。
    *   **对抖动服务宽容:** 自动调高阈值，忽略正常毛刺。
    *   **计算性能:** 这种非对称采样策略大幅降低了 Prometheus 的查询压力，使得“全网扫描”成为可能。

### 3.2 内存加权拓扑挖掘 (At Entry Selection Layer)
*   **统一竞价:** 不再区分“查报错”还是“查耗时”，将两者统一转化为“破坏力权重”。
*   **零 IO:** 算法完全基于已采集的 Trace 和异常列表在内存运行，毫秒级产出最佳分析入口。

---

## 4. 总结

**AIOps-Intelligent-RCA** 的本质是一个 **由算法驱动数据采集，由 LLM 驱动逻辑推理** 的混合系统。

*   **Z-Score 算法** 负责“看见”隐形的故障。
*   **Pearson 相关性** 负责“过滤”物理的噪音。
*   **LLM Agent** 负责“讲述”故障的故事。

我们通过在 Data Pipeline 层的重投入，换取了 Agent 推理层的极简与高准确率。
